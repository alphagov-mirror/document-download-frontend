---
applications:
- name: document-download-frontend

  memory: 512M

  instances: 2

  buildpack: python_buildpack

  {% set hostname={
    "preview": "documents.notify.works",
    "staging": "documents.staging-notify.works",
    "production": "documents.service.gov.uk"
  }[environment] %}

  routes:
    - route: document-download-frontend-{{ environment }}.cloudapps.digital
    - route: {{ hostname }}

  health-check-type: http
  health-check-http-endpoint: '/_status'

  processes:
    - type: web
      command: web: unset GUNICORN_CMD_ARGS; gunicorn -c gunicorn_config.py application
      health-check-type: process
      memory: 2G

  services:
    - logit-ssl-syslog-drain

  sidecars:
    - name: aws-logs
      process_types:
        - web
      command: >
        touch /home/vcap/logs/gunicorn_error.log &&
        touch /home/vcap/logs/app.log.json &&
        aws configure set plugins.cwlogs cwlogs &&
        aws logs push --region eu-west-1 --config-file awslogs.conf
      memory: 64M

  env:
    ADMIN_BASE_URL: {{ ADMIN_BASE_URL }}
    ADMIN_CLIENT_SECRET: {{ ADMIN_CLIENT_SECRET }}
    API_HOST_NAME: {{ API_HOST_NAME }}


    NOTIFY_APP_NAME: document-download-frontend
    FLASK_APP: application.py
    DOCUMENT_DOWNLOAD_API_HOST_NAME: https://{{ hostname }}
    FLASK_ENV: {{ environment }}
    AWS_ACCESS_KEY_ID: {{ AWS_ACCESS_KEY_ID }}
    AWS_SECRET_ACCESS_KEY: {{ AWS_SECRET_ACCESS_KEY }}
